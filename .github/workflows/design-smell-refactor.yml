# Design Smell Detection and Refactoring Pipeline
# Daily automated pipeline that detects design smells using DesigniteJava
# and TypeMetrics, refactors code using Groq AI (FREE!), and creates Pull Requests.

name: Design Smell Detection and Refactoring

on:
  schedule:
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without creating PR'
        required: false
        default: 'false'
        type: boolean
      max_files:
        description: 'Maximum files to refactor'
        required: false
        default: '5'
        type: string

env:
  JAVA_VERSION: '11'
  PYTHON_VERSION: '3.11'

jobs:
  detect-and-refactor:
    name: Detect Smells and Refactor
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'zulu'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install -r design_smell_pipeline/requirements.txt
          
      - name: Download DesigniteJava
        run: |
          mkdir -p design_smell_pipeline/tools
          echo "DesigniteJava should be downloaded or provided as a secret/artifact"
          
      - name: Build Project
        run: mvn compile -q
        
      - name: Run Design Smell Detection
        id: detection
        run: |
          cd design_smell_pipeline
          
          if [ -f "tools/DesigniteJava.jar" ]; then
            java -jar tools/DesigniteJava.jar -i ../app/src/main/java -o output/smells
          else
            echo "DesigniteJava not available, using TypeMetrics only"
          fi
          
          python -c "
          from detection import SmellParser
          import yaml
          import json
          
          with open('config/config.yaml') as f:
              config = yaml.safe_load(f)
          
          parser = SmellParser(config)
          parser.run_detection()
          reports = parser.get_top_files_for_refactoring()
          
          print(f'Files to refactor: {len(reports)}')
          for r in reports:
              print(f'  - {r.class_name}: {r.total_smells} smells')
          
          with open('output/detection_report.json', 'w') as f:
              json.dump([r.to_dict() for r in reports], f, indent=2)
          "
          
      - name: Upload Detection Report
        uses: actions/upload-artifact@v4
        with:
          name: detection-report
          path: design_smell_pipeline/output/
          retention-days: 30
          
      - name: Run LLM Refactoring with Groq
        id: refactoring
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd design_smell_pipeline
          
          DRY_RUN=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN="--dry-run"
          fi
          
          python main.py --config config/config.yaml $DRY_RUN
          
      - name: Validate Refactored Code
        if: success()
        run: |
          mvn compile -q
          mvn test -q || echo "Some tests may have failed"
          
      - name: Generate Validation Report
        if: always()
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Compilation | Done |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | Done |" >> $GITHUB_STEP_SUMMARY
          
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Design Smell Pipeline Failed',
              body: 'The automated design smell detection pipeline failed on ' + new Date().toISOString() + '. Please check the workflow run for details.',
              labels: ['pipeline-failure', 'automated']
            })
